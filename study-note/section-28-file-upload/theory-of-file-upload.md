# Theory of file upload

## 문서 작성 시점 기준 구현된 이미지 업로드 방식
- 제목, 내용, 이미지를 모두 선택한 다음 모든 정보를 한번에 서버로 업로드한다.
- 단순 텍스트는 크기가 작기 때문에 업로드 속도가 빠르지만 파일은 업로드가 오래 걸릴 수 있다.
- 업로드 버튼을 누른 뒤에 제목, 내용, 이미지를 서버로 업로드하면 사용자는 프로그램이 느리다는 인상을 받을 수 있다.
- 특히나 한번에 여러개의 이미지를 업로드 하는 기획이라면 업로드 버튼을 누른 후 업로드가 끝날 때까지 사용자가 오랜 시간을 기다려야 할 수 있다.

## 앞으로 변경할 방식
- 업로드 버튼을 누르는 순간 한번에 포스트를 업로드 하는게 아니라 이미지를 선택할 때마다 이미지는 먼저 업로드를 진행한다.
- 업로드 된 이미지들은 '임시' 폴더에 잠시 저장해둔다.(/public/temp)
- 이미지 업로드를 한 후 응답받은 이미지의 경로만 저장해둔 후 포스트를 업로드 할 때마다 이미지의 경로만 추가해준다.
- `POST` /posts 엔드포인트에 이미지 경로를 함께 보낼 경우 해당 이미지를 임시 폴더(/public/temp)에서 부터 포스트 폴더 (/public/posts)로 이동시킨다.
- PostEntity의 image 필드에 경로를 추가해준다.
- `S3` `presigned url`을 사용하면 많이 사용 되는 방식이다.

### 장단점
|  | 기존 방식      | 신규 방식           |
| ------ | --------- | -------------- |
| 체감 속도       | 이미지가 업로드 되는 시간을 사용자가 처음부터 끝까지 기다리기 때문에 체감 시간이 길다.(사용자는 서비스가 느리다고 느낌) | 이미지를 선택하자마자 먼저 업로드를 진행하기 때문에 속도감이 좋다. 특히나 인스타처럼 이미지를 먼저 선택하는 UI를 만든다면 글을 작성하는 동안 이미지 업로드를 진행 할 수 있다. |
| 서버 과부하     | 사용자가 실제 포스팅 (업로드) 버튼을 눌렀을때만 요청이 보내지기 때문에 포스트 하나당 한번의 요청만 보내진다. | 이미지를 선택할 때마다 업로드를 진행하기 때문에 더욱 많은 요청을 받게 된다. 특히나 이미지를 선택한 후 삭제해서 실제 포스트에 포함하지 않을 경우 서버 리소스만 낭비한다. |
| 엔드포인트 관리 | 파일을 업로드 해야 하는 엔드포인트가 생길때마다 파일 업로드 관련 `multer` 세팅을 계속 해줘야 한다. | 공통된 이미지 업로드 엔드포인트를 하나 만들어서 모든 이미지 업로드를 한번에 관리 할 수 있다. |  
| 파일 관리 | 실제 포스팅 버튼을 눌렀을때만 파일이 업로드 되기 때문에 잉여 파이리 생길 가능성이 적다. | 이미지를 선택하면 바로 업로드를 진행하기 때문에 선택한 이미지를 삭제하거나 변경하면 잉여 파일이 생긴다. 잉여 파일들은 주기적으로 삭제 해줘야 한다. |

